using Test
using Random

include("./2-sum-htable.jl")

@testset "2-sum" begin
  keys = [2225, 1687, 2354, -5893, -3087, -4729, -7169, 4941, 4863, -4997, -1480, -5220, 936, -6893, -7877, 1067, -8028, 151, -2841, 8768, 8802, -5526, -3937, 8909, 5341, 4394, 5404, -6116, 9128, 3863, 7161, 6642, 9720, -7241, 2746, -3129, 8745, -6331, -6771, -4092, 9678, 4465, 4625, -2471, 4645, -8972, -697, 1252, 4044, 182, -6980, 8222, 9086, -6327, 3797, -8484, 9702, 3397, 476, 5658, -437, 1481, 1917, 1555, 5445, -2051, -2389, -7297, -187, -570, 6414, -7810, -1847, -6198, 1080, -8115, -8681, -592, -8062, 6220, 5858, -332, 6256, -1946, 3561, -6803, -3498, -6504, 1984, -8001, -3239, 2178, -6628, -8112, -2672, -1922, 6107, 3886, -4945, -1984, -3444, 1491, 1867, -6884, -7845, -9006, 2558, 6914, -2693, -600, -9354, 5436, 918, 7519, 2189, 9373, 4254, 146, 2834, -7428, -7627, 7419, -4253, 8629, -6619, 5983, 2923, 965, 1880, -2562, -2260, -3068, 3358, 8620, 4374, 6448, 6596, -5951, -9470, -3318, -8211, -7867, -5398, -324, -4056, 4802, -9085, -8516, -2405, -4086, -8990, -5905, 9952, -4607, -8061, -4091, -8899, 42, 3833, 2522, -1886, 3987, -9185, 7997, 1389, 5030, 1850, 225, 1285, -8900, -6168, -4496, -4086, 8980, -3099, 8734, 2134, 1675, 6713, -2686, 3969, 3377, 9578, 2949, 7257, 9194, -3762, 922, 5604, 5269, 3195, -6604, 4409, 9465, -9992, -7068, 9046, 5083, -5088, 8058, 2335, 5370, 4702, -3293, 6398, 9855, -2795, -6935, -8178, 5573, -7414, 1718, 5584, 2690, -3831, 4711, 8519, 1032, -7476, -6452, 7780, 4793, -3248, 3851, 8325, 1178, -3158, 1503, 6170, -2886, -721, 5554, 8333, 9526, -7317, 2167, -2268, -2664, 7014, -6547, 4270, -9579, -3415, -4652, -8922, -4199, -761, -2299, 1075, -7351, -4588, -9580, -1527, 1399, 1284, -3205, -1859, 7330, 5904, -6979, 7263, 8731, 910, -4657, -7276, 1690, -697, -3083, -1246, -9894, -7633, -8137, 8993, -8131, 5873, -1266, 5443, 6625, -3185, 7344, -8784, 8147, 8017, -1538, 867, 222, -5210, 5382, 5101, -1016, -209, -7260, 5862, 530, -9392, -7878, 8247, 3563, -2814, 6447, -7165, -7310, -1074, 5945, 3104, 3236, 7823, 395, -9312, 7808, -2137, 7181, 922, 6952, -3875, 9508, 2231, -9348, -598, 1727, 8929, -4146, -7266, 9574, 2933, -8625, 2022, 3163, -6077, -4128, -9043, 3939, -8973, -7801, 4117, -2545, 8063, 9870, -2831, -6046, -6022, 5335, -7352, -887, -5599, -7001, 8732, 5906, 5013, -5973, 4980, 2549, -2063, 5858, 1481, 3815, -1684, 905, 7716, -9847, -5718, -3492, -8762, -1060, 8554, -9345, 6603, -9586, 1106, -7388, -9728, -1415, -1835, -5288, 2296, 9436, 8756, -5929, 1600, -8809, -409, 5445, 576, 5712, 481, -897, 8580, -1552, 7958, -9651, -9585, 8994, -8000, -3841, -8738, -51, 8692, 5198, -7755, 3856, 2677, -9588, -1779, 5795, 3857, -4346, -9961, 7512, -1121, 5550, 8491, -2488, -5693, -5847, 9337, 6445, 5502, -9554, 4074, 5558, 2703, 1818, 5719, 392, 3338, -7121, 1022, -8592, 4480, -6381, -3228, -939, -1429, 2918, 6518, -5096, -583, -4655, 3438, -2483, -5471, -5985, -985, -1321, -7098, 6076, 2782, -3746, -9032, -2414, 3404, 1563, 5381, -1354, 5991, 7636, 4388, 5391, -5744, -238, 5721, 6678, 1540, -2974, -9865, 2573, -109, 4291, 4633, -7937, 7097, 8229, -4562, 9861, -2190, 3076, 8398, 6653, -7270, 7787, 7956, 1491, 7850, 5034, 6137, 6102, -9182, -5761, -5787, -6833, -6871, 5382, 465, -323, -77, 844, 5613, -4802, -8324, -7848]
  n = length(keys)

  n_sols, sols = two_sum(;n=n, keys=keys, targets=-10_000:1_000:-1_000, distinct=false, keep=true)
  @test n_sols == 46

  @test sols == Set([(-9580, 8580), (-7165, -1835), (-9392, 392), (-5718, 1718), (-6833, 3833), (-7414, 6414), (-6604, 5604), (-6198, 5198), (-6871, -3129), (-7169, -2831), (-4146, 146), (-3746, 2746), (-8178, 2178), (-9182, 182), (-8178, 1178), (-3205, -2795), (-5761, -3239), (-7270, 4270), (-7388, 4388), (-6022, 1022), (-9032, 1032), (-7867, 867), (-8625, 6625), (-9354, 2354), (-7937, -2063), (-9554, 5554), (-2389, 1389), (-1984, -1016), (-8137, 6137), (-3239, -761), (-6022, 2022), (-5905, 905), (-8061, -939), (-7867, 1867), (-6980, 4980), (-9554, 8554), (-7633, 4633), (-8625, 4625), (-6381, 5381), (-3762, -238), (-1922, 922), (-8762, -238), (-7476, 476), (-3937, -2063), (-7810, -2190), (-8922, 922)])

  n_sols, = two_sum(;n=n, keys=keys, targets=-10_000:1_000:-1_000, distinct=true, keep=false)
  @test n_sols == 10
end

@testset "2-sum on test file" begin
  n_sols, sols = two_sum("testfiles/problem12.4test.txt"; targets=3:10, distinct=true, keep=true)
  @test n_sols == 8
  @test sols == Set([(1, 6), (-3, 7), (-1, 6), (-3, 6), (2, 7), (-1, 11), (-3, 9), (-3, 11)])

  n_sols, sols = two_sum("testfiles/problem12.4test.txt"; targets=3:10, distinct=false, keep=true)
  @test n_sols == 15
  @test sols == Set([(1, 6), (2, 6), (-3, 7), (2, 2), (-3, 6), (-1, 6), (-1, 7), (-3, 9), (1, 7), (1, 9), (-3, 11), (-1, 9), (1, 2), (2, 7), (-1, 11)])
end

## Challenge:
# two_sum("testfiles/problem12.4.txt.BAK") # targets=-10_000:10_000, distinct=true, keep=false

# julia> @time two_sum("testfiles/problem12.4.txt.BAK"; targets=-10_000:10_000)
# ==> distinct=true, keep=false
# file loaded... - length(keys): 1000000
# htab loaded... - size: 999752 / n: 2000000
# ^CError: InterruptException...
# 13442.274799 seconds (150.83 G allocations: 2.829 TiB, 3.21% gc time)
